#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef int (*compar_t)(const void *, const void *);

static uint16_t states[] = {
    0, 1, 1, 14, 499, 4, 4, 6, 1, 1, 2, 5, 9, 14, 18, 15, 49, 15, 113, 14, 242,
    2, 2, 3, 1, 2, 4, 1, 1, 14, 2, 7, 7, 17, 1, 2, 28, 33, 1, 2, 5, 8, 111, 2,
    2, 5, 7, 262, 4, 2, 2, 20, 4, 3, 2, 23, 2, 6, 1, 1, 22, 2, 5, 2, 23, 2, 2,
    4, 1, 1, 22, 7, 2, 23, 2, 7, 55, 4, 3, 1, 1, 23, 7, 2, 23, 2, 7, 55, 9, 114,
    5, 2, 5, 15, 29, 28, 429, 8, 7, 1, 12, 4, 4, 11, 9, 8, 4, 4, 16, 12, 20, 4,
    4, 4, 24, 8, 16, 4, 12, 56, 8, 11, 13, 8, 16, 4, 12, 48, 8, 8, 124, 12, 2,
    1, 9, 4, 2, 1, 1, 4, 7, 1, 2, 1, 9, 6, 1, 5, 2, 8, 1, 5, 2, 2, 2, 1, 1, 2,
    1, 3, 2, 20, 6, 1, 1, 4, 2, 5, 3, 6, 2, 2, 3, 1, 2, 1, 5, 7, 12, 1, 6, 1, 5,
    2, 14, 2, 34, 4, 2, 1, 1, 4, 2, 5, 4, 5, 4, 2, 2, 2, 1, 5, 7, 11, 2, 6, 1,
    5, 2, 14, 36, 6, 1, 5, 232, 2, 1, 61, 2, 1, 31, 1, 31, 1, 61, 2, 1, 31, 1,
    29, 2, 1, 31, 1, 29, 2, 1, 593, 8, 4, 20, 8, 4, 12, 16, 12, 44, 8, 48, 28,
    44, 8, 4, 44, 28, 172, 8, 4, 2, 2, 12, 2, 2, 10, 1, 1, 19, 1, 6, 1, 1, 14,
    1, 4, 8, 7, 1, 29, 4, 2, 13, 1, 2, 56, 40, 2, 12, 2, 14, 26, 250, 128, 58,
    1, 37, 90, 1, 63, 29, 57, 15, 1, 12, 2, 2, 10, 5, 9, 7, 1, 7, 13, 2, 1, 3,
    1, 1, 2, 1, 32, 1, 15, 13, 2, 25, 73, 15, 41, 248, 32, 16, 8, 8, 48, 12, 20,
    8, 20, 4, 8, 40, 16, 12, 4, 16, 8, 8, 12, 4, 32, 12, 16, 4, 12, 12, 120, 32,
    16, 8, 4, 2, 1, 1, 32, 16, 8, 4, 2, 1, 1, 16, 8, 6, 1, 1, 8, 4, 2, 2, 4, 2,
    2, 6, 1, 49, 8, 4, 2, 1, 17, 8, 6, 1, 9, 4, 2, 2, 4, 4, 4, 2, 1, 17, 8, 6,
    1, 13, 2, 2, 8, 4, 2, 1, 9, 7, 1105, 72, 440, 63, 15, 1, 7, 1, 616, 23, 1,
    104, 23, 1, 104, 23, 1, 69, 2, 18, 8, 16, 7, 8, 56, 401, 32, 28, 4, 32, 30,
    2, 32, 8, 12, 72, 2, 18, 8, 8, 8, 12, 8, 48, 18, 10, 32, 88, 60, 36, 16, 12,
    4, 16, 8, 16, 7, 13, 36, 16, 16, 16, 24, 7, 49, 16, 32, 24, 7, 637, 2, 1,
    465, 48, 48, 16, 16, 24, 16, 4, 4, 6, 5, 37, 16, 40, 16, 4, 4, 6, 26, 16,
    16, 24, 16, 12, 4, 88, 32, 16, 16, 48, 12, 2, 2, 40, 4, 4, 4, 44, 28, 36, 8,
    4, 4, 76, 48, 596, 32, 32, 32, 32, 32, 64, 32, 32, 64, 352, 128, 64, 320,
    128, 64, 3232, 16, 8, 120, 112, 16, 8, 120, 112, 16, 8, 104, 15, 1, 8, 120,
    655, 577, 56, 56, 72, 72, 256, 128, 768, 191, 64, 705, 624, 1152, 8, 4, 2,
    1, 105, 8, 14, 1, 105, 8, 8, 6, 242, 8, 4, 116, 8, 4, 116, 648, 4, 2, 114,
    127, 769, 15, 449, 48, 652, 2, 1, 889, 504, 12, 1012, 8704, 272, 6384, 3216,
    512, 640, 128, 1024, 384, 2048, 3584, 128, 384, 128};

static uint8_t moves[] = {
    0, 4, 0, 0, 3, 3, 4, 1, 0, 7, 6, 5, 6, 3, 4, 2, 4, 0, 4, 2, 4, 3, 4, 4, 6,
    6, 1, 0, 8, 2, 4, 2, 1, 0, 3, 3, 3, 0, 6, 8, 4, 3, 2, 4, 4, 4, 1, 3, 2, 1,
    5, 2, 3, 2, 0, 2, 1, 2, 7, 5, 2, 1, 2, 0, 2, 1, 6, 2, 0, 1, 3, 0, 1, 2, 1,
    0, 2, 3, 2, 2, 1, 2, 0, 0, 2, 1, 0, 6, 0, 0, 2, 1, 0, 6, 0, 0, 4, 3, 0, 5,
    6, 4, 8, 0, 7, 8, 8, 7, 4, 8, 6, 6, 4, 8, 4, 2, 4, 3, 8, 6, 2, 0, 6, 2, 3,
    7, 7, 2, 6, 6, 4, 2, 1, 0, 7, 8, 1, 0, 4, 7, 2, 8, 8, 7, 4, 8, 7, 7, 7, 8,
    7, 2, 8, 3, 4, 4, 4, 4, 4, 3, 7, 5, 4, 6, 6, 6, 6, 5, 1, 6, 8, 3, 4, 8, 4,
    4, 6, 0, 4, 3, 8, 0, 2, 1, 2, 8, 3, 2, 6, 4, 4, 7, 6, 5, 0, 3, 4, 4, 2, 4,
    6, 2, 2, 4, 3, 1, 7, 7, 1, 2, 3, 1, 0, 6, 2, 1, 0, 2, 1, 0, 1, 8, 1, 0, 2,
    1, 0, 7, 0, 2, 1, 0, 1, 0, 2, 1, 0, 6, 8, 8, 8, 8, 2, 3, 3, 3, 4, 3, 4, 4,
    5, 5, 2, 3, 2, 4, 7, 6, 6, 5, 4, 8, 8, 1, 0, 6, 4, 4, 1, 0, 3, 4, 4, 0, 2,
    1, 0, 3, 6, 6, 2, 6, 6, 4, 5, 4, 6, 6, 2, 3, 6, 6, 1, 0, 5, 1, 0, 1, 0, 4,
    5, 5, 4, 4, 4, 1, 0, 4, 0, 5, 5, 4, 4, 4, 2, 2, 2, 4, 4, 4, 4, 0, 4, 4, 8,
    4, 5, 4, 7, 7, 7, 8, 7, 6, 2, 5, 8, 4, 4, 8, 7, 6, 6, 6, 7, 7, 7, 4, 7, 4,
    6, 4, 6, 6, 4, 8, 8, 8, 7, 7, 1, 0, 8, 8, 8, 6, 8, 6, 6, 8, 8, 5, 8, 8, 8,
    3, 4, 8, 8, 3, 3, 3, 8, 8, 6, 3, 7, 6, 6, 5, 3, 7, 7, 3, 4, 4, 4, 3, 7, 7,
    7, 7, 5, 6, 6, 6, 4, 4, 4, 6, 2, 6, 6, 4, 4, 8, 8, 7, 0, 4, 4, 1, 0, 0, 1,
    0, 0, 3, 0, 0, 1, 0, 2, 1, 5, 3, 7, 0, 0, 0, 6, 8, 8, 8, 5, 1, 6, 8, 4, 2,
    6, 6, 4, 3, 7, 3, 2, 2, 2, 6, 3, 3, 6, 7, 6, 8, 2, 6, 4, 3, 4, 4, 2, 6, 7,
    6, 4, 4, 0, 6, 4, 4, 4, 0, 2, 1, 0, 8, 4, 5, 4, 6, 3, 4, 4, 4, 1, 0, 5, 4,
    5, 3, 2, 4, 3, 6, 5, 4, 5, 3, 3, 3, 8, 5, 4, 7, 4, 6, 6, 8, 3, 2, 4, 8, 5,
    6, 5, 4, 4, 4, 6, 4, 6, 5, 7, 5, 6, 5, 5, 6, 5, 5, 8, 7, 6, 8, 7, 6, 8, 4,
    3, 4, 5, 4, 3, 4, 7, 4, 7, 5, 0, 4, 3, 4, 0, 6, 8, 6, 3, 6, 7, 6, 6, 0, 6,
    7, 4, 4, 7, 7, 1, 0, 8, 4, 1, 0, 3, 4, 3, 1, 4, 8, 8, 4, 8, 8, 4, 3, 2, 1,
    4, 0, 4, 0, 6, 4, 2, 1, 0, 3, 4, 2, 4, 4, 8, 4, 7, 8, 8, 7, 7, 8, 8, 8, 7,
    8, 7};

static uint8_t flipped[][9] = {
    {0, 1, 2, 3, 4, 5, 6, 7, 8}, {2, 1, 0, 5, 4, 3, 8, 7, 6},
    {8, 7, 6, 5, 4, 3, 2, 1, 0}, {8, 5, 2, 7, 4, 1, 6, 3, 0},
    {2, 5, 8, 1, 4, 7, 0, 3, 6}, {0, 3, 6, 1, 4, 7, 2, 5, 8},
    {6, 3, 0, 7, 4, 1, 8, 5, 2}, {6, 7, 8, 3, 4, 5, 0, 1, 2}};

static uint16_t rows[] = {7, 56, 73, 84, 146, 273, 292, 448};

static void print_board(uint16_t x, uint16_t o) {
    char b[9];

    for (int i = 0; i < 9; ++i)
        if (x & 1 << i)
            b[i] = 'x';
        else if (o & 1 << i)
            b[i] = 'o';
        else
            b[i] = '-';

    printf("\n%.3s\n%.3s\n%.3s\n\n", b, &b[3], &b[6]);
}

static int compar(const uint16_t *a, const uint16_t *b) {
    return *a < *b ? -1 : *a > *b ? 1 : 0;
}

static uint16_t compress(uint16_t x, uint16_t o) {
    uint16_t m = x | o, r = m, s = 9, b;

    do {
        b = m & 1;
        r |= (o & b) << s;
        s += b;
        o >>= 1;
        m >>= 1;
    } while (m);

    return r;
}

static uint32_t flip_lr(uint32_t xo) {
    return (xo & 74898) | (xo >> 2 & 37449) | (xo << 2 & 149796);
}

static uint32_t flip_tb(uint32_t xo) {
    return (xo & 28728) | (xo >> 6 & 3591) | (xo << 6 & 229824);
}

static uint32_t flip_bs(uint32_t xo) {
    return (xo & 140049) | (xo >> 2 & 17442) | (xo << 2 & 69768) |
           (xo >> 4 & 2052) | (xo << 4 & 32832);
}

static uint32_t (*const flip[])(uint32_t) = {
    flip_lr, flip_tb, flip_bs, flip_lr, flip_tb, flip_lr, flip_bs, flip_tb};

static void init(void) {
    for (int i = 1; i < 627; ++i)
        states[i] += states[i - 1];
}

static int valid_move(uint16_t x, uint16_t o, uint8_t m) {
    return 0 <= m && m <= 8 && ((x | o) & 1 << m) == 0;
}

static uint8_t player_move(uint16_t x, uint16_t o) {
    char s[3];
    uint8_t m;

    for (;;) {
        printf("move: ");

        if (scanf("%2s%*[^\n]%*c", s) != 1)
            return (uint8_t)-1;

        if (s[1] != '\0')
            continue;

        m = s[0] - '1';

        if (valid_move(x, o, m))
            return m;
    }
}

static uint8_t compute_move(uint32_t xo) {
    uint16_t k, *s;

    for (int i = 0; i < 8; ++i) {
        k = compress(xo & 511, xo >> 9);
        s = bsearch(&k, states, 627, sizeof(uint16_t), (compar_t)compar);

        if (s)
            return flipped[i][moves[s - states]];
        else
            xo = flip[i](xo);
    }

    return (uint8_t)-1;
}

static uint32_t make_move(uint32_t xo, uint8_t m, int s) {
    return xo | 1 << (s ? 9 + m : m);
}

static int draw(uint16_t x, uint16_t o) {
    return (x | o) == 511;
}

static int win(uint16_t x) {
    return (x & rows[0]) == rows[0] || (x & rows[1]) == rows[1] ||
           (x & rows[2]) == rows[2] || (x & rows[3]) == rows[3] ||
           (x & rows[4]) == rows[4] || (x & rows[5]) == rows[5] ||
           (x & rows[6]) == rows[6] || (x & rows[7]) == rows[7];
}

int main(int argc, char const *argv[]) {
    int p = argc > 1 && strcmp(argv[1], "-o") == 0, s = 0;
    uint32_t xo = 0;
    uint16_t x, o;
    uint8_t m;

    init();
    print_board(0, 0);

    for (;;) {
        m = s == p ? player_move(x, o) : compute_move(xo);

        if (m == (uint8_t)-1) {
            printf("Game over\n\n");
            break;
        }

        if (s != p)
            printf("move: %u\n", m + 1);

        xo = make_move(xo, m, s);
        x = xo & 511;
        o = xo >> 9;

        print_board(x, o);

        if (draw(x, o)) {
            printf("It's a draw\n\n");
            break;
        }

        if (win(s ? o : x)) {
            printf("%c win\n\n", "xo"[s]);
            break;
        }

        s = !s;
    }

    return 0;
}
